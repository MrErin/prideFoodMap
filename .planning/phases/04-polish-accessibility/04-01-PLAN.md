---
phase: 04-polish-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cards.ts
  - src/cards.css
autonomous: true

must_haves:
  truths:
    - 'Clicking a marker scrolls the card list to show the corresponding card'
    - "Card scroll behavior respects user's prefers-reduced-motion setting"
    - 'After auto-scroll, keyboard focus moves to the selected card'
    - "Scroll uses 'nearest' block position for minimal viewport disruption"
  artifacts:
    - path: 'src/cards.ts'
      provides: 'Auto-scroll implementation with motion preference detection'
      exports: ['scrollToCard', 'updateCardSelection']
      contains: 'scrollIntoView'
    - path: 'src/cards.css'
      provides: 'Focus indicator styling for keyboard accessibility'
      contains: '.card:focus'
  key_links:
    - from: 'src/cards.ts'
      to: 'src/main.ts StateManager.subscribe'
      via: 'updateCardSelection function call'
      pattern: "stateManager\\.subscribe.*updateCardSelection"
    - from: 'src/cards.ts'
      to: 'HTMLElement.scrollIntoView()'
      via: 'scrollToCard function'
      pattern: 'scrollIntoView'
---

<objective>
Implement auto-scroll to card on marker click with smooth scroll behavior that respects accessibility preferences.

Purpose: When users click a map marker, the corresponding card should scroll into view so they can see the location details. This creates a seamless connection between map interaction and the card list. Auto-scroll must respect user motion preferences (prefers-reduced-motion) and move keyboard focus so keyboard users can continue navigating.

Output: Updated updateCardSelection function that scrolls the selected card into view, new scrollToCard helper function, and CSS focus styling for keyboard accessibility.
</objective>

<execution_context>
@/home/erinmeaker/.claude/get-shit-done/workflows/execute-plan.md
@/home/erinmeaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-accessibility/04-RESEARCH.md

# Prior phases provide these patterns:

@src/cards.ts - existing updateCardSelection function uses requestAnimationFrame timing
@src/stateManager.ts - Observer pattern for state changes
@src/main.ts - StateManager.subscribe already triggers updateCardSelection

# Phase 3 completed:

@.planning/phases/03-search-filter-integration/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create scrollToCard helper function</name>
  <files>src/cards.ts</files>
  <action>
    Add a new exported function scrollToCard(card: HTMLElement): void that:

    1. Checks window.matchMedia('(prefers-reduced-motion: reduce)').matches for motion preference
    2. Calls card.scrollIntoView() with options:
       - behavior: 'smooth' if prefersReducedMotion is false, else 'auto'
       - block: 'nearest' (minimal disruption, doesn't hide cards above selection)
    3. Calls card.focus() to move keyboard focus (critical for accessibility)

    Use the pattern from RESEARCH.md > Pattern 1: Auto-Scroll with Accessibility.

    Do NOT use setTimeout. scrollIntoView is synchronous and focus() should happen immediately after.

  </action>
  <verify>
    Function exists in src/cards.ts with correct signature and implementation
  </verify>
  <done>
    scrollToCard function accepts HTMLElement, checks prefers-reduced-motion, calls scrollIntoView with appropriate options, and calls focus()
  </done>
</task>

<task type="auto">
  <name>Update updateCardSelection to call scrollToCard</name>
  <files>src/cards.ts</files>
  <action>
    Modify the existing updateCardSelection function to call scrollToCard on the selected card.

    Current implementation (lines 92-109):
    - Iterates all cards, sets aria-selected and adds/removes 'selected' class
    - Uses requestAnimationFrame for DOM timing

    Required changes:
    1. Inside the requestAnimationFrame callback, after setting aria-selected='true' and adding 'selected' class
    2. Call scrollToCard(card) on the selected card (when markerId === selectedId)
    3. Only call scrollToCard when a card is actually selected (selectedId is not null)

    Do NOT modify the clear selection logic (else branch). Scroll only happens on selection, not deselection.

  </action>
  <verify>
    updateCardSelection calls scrollToCard for selected card within requestAnimationFrame
  </verify>
  <done>
    When markerId === selectedId, after setting aria-selected and class, scrollToCard(card) is called
  </done>
</task>

<task type="auto">
  <name>Add CSS focus styling for cards</name>
  <files>src/cards.css</files>
  <action>
    Add CSS rule for card focus state to distinguish keyboard focus from mouse selection.

    Current CSS has:
    - .card[aria-selected='true'] for selection styling (blue border, box-shadow)
    - :focus styles exist globally (*:focus { outline: 3px solid #007bff; })

    Add specific card focus styling:
    ```css
    /* Card focus state (keyboard navigation) - distinct from selection */
    .card:focus {
      outline: 3px solid #007bff;
      outline-offset: 2px;
    }
    ```

    This ensures:
    1. Focus indicator is visible when keyboard user navigates to card
    2. Focus and selection have distinct visual styles (focus follows keyboard, selection follows click/Enter)
    3. High contrast mode compatibility (outline is visible)

    Add comment explaining focus vs selection distinction.

  </action>
  <verify>
    .card:focus rule exists in src/cards.css with outline and outline-offset
  </verify>
  <done>
    CSS includes .card:focus rule with visible outline, distinct from [aria-selected='true'] styling
  </done>
</task>

</tasks>

<verification>
Overall verification steps:

1. Test auto-scroll with mouse: Click a map marker, verify corresponding card scrolls into view and gets keyboard focus
2. Test motion preference: Enable OS "reduce motion" setting, verify scroll is instant (not smooth)
3. Test keyboard continuity: After marker click triggers scroll, press Tab to verify focus is on card
4. Run existing tests: npm test to ensure no regressions in card selection behavior

Expected behavior:

- Clicking marker scrolls card list so corresponding card is visible
- Scrolled card receives keyboard focus (visible outline)
- With prefers-reduced-motion: scroll is instant, no animation
- Without prefers-reduced-motion: scroll is smooth
  </verification>

<success_criteria>

1. Clicking any map marker auto-scrolls the card list to show the corresponding card
2. Scrolled card receives keyboard focus (visible with .card:focus outline)
3. Auto-scroll respects prefers-reduced-motion system preference (smooth vs instant)
4. No test failures: npm test passes
5. Focus indicator is visually distinct from selection border
   </success_criteria>

<output>
After completion, create `.planning/phases/04-polish-accessibility/04-01-SUMMARY.md`

Summary should include:

- scrollToCard function implementation with motion preference detection
- Changes to updateCardSelection for scroll integration
- CSS focus styling added
- Manual testing results for auto-scroll behavior
  </output>
