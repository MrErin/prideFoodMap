---
phase: 04-polish-accessibility
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.ts
  - src/cards.ts
  - src/map.ts
autonomous: true

must_haves:
  truths:
    - "Users can navigate cards with keyboard (Tab to navigate, Enter to select, Escape to deselect)"
    - "Pressing Enter on a focused card selects it and highlights corresponding marker"
    - "All interactive elements have proper ARIA attributes (aria-selected, aria-live, role)"
    - "Search input announces results to screen readers via aria-live region"
    - "Empty state announces when no results match search query"
  artifacts:
    - path: "src/main.ts"
      provides: "Keyboard event listeners for card activation"
      contains: "keydown"
    - path: "src/cards.ts"
      provides: "Card creation with complete ARIA attributes"
      contains: "setAttribute"
    - path: "src/map.ts"
      provides: "Marker ARIA attributes and keyboard handlers"
      contains: "role, aria-label, tabindex"
  key_links:
    - from: "src/main.ts"
      to: "src/cards.ts createCardElement"
      via: "card.forEach addEventListener keydown"
      pattern: "addEventListener.*keydown"
    - from: "src/main.ts"
      to: "src/stateManager.ts setSelected"
      via: "Enter key handler"
      pattern: "stateManager\\.setSelected"
    - from: "src/cards.ts"
      to: "DOM elements"
      via: "createCardElement ARIA attributes"
      pattern: "setAttribute.*aria-"
---

<objective>
Add keyboard navigation and complete ARIA attribute coverage for all interactive elements.

Purpose: Users should be able to navigate and interact with the application using only a keyboard. This includes Tab navigation to cards, Enter key to select cards, and Escape to clear selection. All interactive elements must have proper ARIA attributes so screen readers can announce state changes and describe available actions.

Output: Keyboard event listeners on cards for Enter/Space activation, verified ARIA attributes on all interactive elements (cards, markers, search input, empty state), and Escape key handling for selection clearing.
</objective>

<execution_context>
@/home/erinmeaker/.claude/get-shit-done/workflows/execute-plan.md
@/home/erinmeaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-accessibility/04-RESEARCH.md

# Prior phases provide these patterns:
@src/cards.ts - createCardElement sets role='listitem', aria-selected, tabindex='0'
@src/main.ts - Escape key listener already exists on window (line 69-74)
@src/map.ts - Markers have keyboard handlers for Enter/Space (lines 101-106)
@src/emptyState.ts - aria-live="polite" for empty state announcements
@.planning/phases/03-search-filter-integration/03-02-SUMMARY.md - Search implementation patterns

# ARIA already present (verify completeness):
- Cards: role="listitem", aria-selected, tabindex="0" (createCardElement)
- Markers: role="button", aria-label, tabindex="0" (map.ts addMarkersFromCSV)
- Layer control: role="group", aria-label on inputs (map.ts initializeMap)
- Empty state: role="status", aria-live="polite" (emptyState.ts)
- Search input: needs verification (index.html or created dynamically)
</context>

<tasks>

<task type="auto">
  <name>Add keyboard event listeners to cards in main.ts</name>
  <files>src/main.ts</files>
  <action>
    Add keydown event listener to cards for Enter and Space key activation.

    Current code (lines 48-60) sets up click handlers on cards. Modify this section to also add keyboard support:

    ```typescript
    // Setup card click and keyboard handlers
    const cardContainer = document.querySelector<HTMLElement>('#card-list');
    if (cardContainer) {
      const cards = cardContainer.querySelectorAll<HTMLElement>('.card');
      cards.forEach((card) => {
        const markerId = card.dataset.markerId;
        if (markerId) {
          // Click handler (existing)
          card.addEventListener('click', () => {
            stateManager.setSelected(markerId);
          });

          // NEW: Keyboard handler for Enter and Space
          card.addEventListener('keydown', (e: KeyboardEvent) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault(); // Prevent Space from scrolling page
              stateManager.setSelected(markerId);
            }
          });
        }
      });
    }
    ```

    Pattern from RESEARCH.md > Pattern 2: Keyboard Navigation for Cards.

    Note: Escape key handling already exists on window (lines 69-74), so no changes needed there.
  </action>
  <verify>
    keydown event listener added to cards in main.ts with Enter and Space key handling
  </verify>
  <done>
    Each card has keydown listener that prevents default on Space and calls stateManager.setSelected() for Enter/Space
  </done>
</task>

<task type="auto">
  <name>Verify and document ARIA attribute coverage</name>
  <files>src/cards.ts, src/map.ts, src/main.ts</files>
  <action>
    Review all interactive elements to verify ARIA attribute coverage. Add any missing attributes.

    Check each element:

    1. CARDS (src/cards.ts createCardElement):
       - role="listitem" ✓ (line 19)
       - aria-selected="false"/"true" ✓ (line 20, updated in updateCardSelection)
       - tabindex="0" ✓ (line 21)
       - VERIFIED: Complete

    2. MARKERS (src/map.ts addMarkersFromCSV):
       - role="button" ✓ (line 97)
       - aria-label with location name ✓ (line 98)
       - tabindex="0" ✓ (line 99)
       - VERIFIED: Complete

    3. CARD LIST CONTAINER (src/cards.ts renderCards):
       - aria-label="Food locations list" ✓ (line 83)
       - VERIFIED: Complete

    4. LAYER CONTROL (src/map.ts initializeMap):
       - role="group" ✓ (line 280)
       - aria-label="Map Layer Controls" ✓ (line 281)
       - aria-label on inputs ✓ (lines 284-289)
       - VERIFIED: Complete

    5. SEARCH INPUT (src/main.ts line 77):
       - Search input needs aria-label for accessibility
       - Add: searchInput.setAttribute('aria-label', 'Search locations by name');
       - After line 78, add ARIA attribute

    6. SEARCH RESET BUTTON (src/main.ts line 78):
       - Reset button needs aria-label
       - Add: searchReset.setAttribute('aria-label', 'Clear search');
       - After line 78, add ARIA attribute

    7. EMPTY STATE (src/emptyState.ts):
       - role="status" ✓ (line 36)
       - aria-live="polite" when visible ✓ (line 77)
       - VERIFIED: Complete

    Add JSDoc comments to each create function documenting the ARIA attributes present.
  </action>
  <verify>
    All interactive elements have appropriate ARIA attributes (cards, markers, search, reset, layer control, empty state)
  </verify>
  <done>
    Search input and reset button have aria-label attributes. JSDoc comments document ARIA coverage in createCardElement and renderCards.
  </done>
</task>

<task type="auto">
  <name>Add ARIA announcement for card selection</name>
  <files>src/main.ts</files>
  <action>
    Add screen reader announcement when card is selected via keyboard.

    Modify the StateManager.subscribe that handles selection (lines 84-87):

    Current:
    ```typescript
    stateManager.subscribe((state) => {
      updateCardSelection(state.selectedId);
      highlightMarker(state.selectedId);
    });
    ```

    Update to announce selection:
    ```typescript
    import { announce } from './map.ts';

    // Subscribe to state changes for bi-directional sync
    stateManager.subscribe((state) => {
      updateCardSelection(state.selectedId);
      highlightMarker(state.selectedId);

      // Announce selection to screen readers
      if (state.selectedId) {
        const selectedCard = document.querySelector<HTMLElement>(`[data-marker-id="${state.selectedId}"]`);
        const cardName = selectedCard?.querySelector('.card-name')?.textContent ?? '';
        if (cardName) {
          announce(`Selected ${cardName}`);
        }
      }
    });
    ```

    Import announce function from map.ts at top of file.

    Note: announce() function uses requestAnimationFrame internally (map.ts lines 54-62), so timing is already handled.
  </action>
  <verify>
    announce() called when card is selected, with card name in announcement
  </verify>
  <done>
    StateManager.subscribe for selection calls announce() with selected card name when state.selectedId is not null
  </done>
</task>

</tasks>

<verification>
Overall verification steps:

1. Test keyboard navigation:
   - Press Tab to navigate to cards
   - Press Enter on a card, verify marker highlights on map
   - Press Space on a card, verify marker highlights on map
   - Press Escape, verify selection clears

2. Test screen reader announcements:
   - Navigate with keyboard to card
   - Press Enter, verify screen reader announces "Selected [card name]"
   - Click marker, verify card scrolls and screen reader announces selection

3. Verify ARIA attributes:
   - Inspect search input: has aria-label="Search locations by name"
   - Inspect reset button: has aria-label="Clear search"
   - Inspect card: has role="listitem", aria-selected, tabindex="0"
   - Inspect layer control: has role="group", aria-label on inputs

4. Run tests: npm test passes
5. Build check: npm run build succeeds

Expected behavior:
- Tab reaches all interactive elements in logical order
- Enter/Space on card activates selection (same as click)
- Escape clears selection from anywhere
- Screen reader announces selection changes
- All interactive elements have descriptive ARIA labels
</verification>

<success_criteria>
1. Keyboard users can navigate to cards with Tab key
2. Pressing Enter or Space on a focused card selects it (same behavior as click)
3. Pressing Escape clears selection (already works, verify no regressions)
4. Search input has aria-label="Search locations by name"
5. Reset button has aria-label="Clear search"
6. Card selection announces to screen readers via announce() function
7. All existing ARIA attributes remain intact
8. No test failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-accessibility/04-02-SUMMARY.md`

Summary should include:
- Keyboard event listener implementation for cards
- ARIA attribute verification results (what was missing, what was added)
- announce() integration for selection feedback
- Manual testing results for keyboard navigation
- Screen reader testing notes (if performed)
</output>
