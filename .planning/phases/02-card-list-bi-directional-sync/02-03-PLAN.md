---
phase: 02-card-list-bi-directional-sync
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - src/map.ts
  - src/main.ts
  - src/stateManager.ts
  - src/cards.ts
autonomous: true

must_haves:
  truths:
    - 'Clicking a card highlights the corresponding map marker with visible border'
    - 'Clicking a map marker highlights the corresponding card with visible border'
    - 'Only one item is highlighted at a time (single selection)'
    - 'Pressing Escape clears all selections'
    - 'Marker-card linking uses L.Util.stamp() for unique IDs'
  artifacts:
    - path: 'src/map.ts'
      provides: 'Extended with marker-card linking and click handlers'
      contains: ['marker-card map', 'L.Util.stamp', 'stateManager', 'highlightMarker']
    - path: 'src/main.ts'
      provides: 'Integration of cards, StateManager, and marker linking'
      contains: ['StateManager', 'renderCards', 'linkMarkersToCards']
    - path: 'src/stateManager.ts'
      provides: 'Export StateManager for use in map.ts and main.ts'
      exports: ['StateManager']
    - path: 'src/cards.ts'
      provides: 'Updated to accept markerId and handle selection styling'
      contains: ['aria-selected', 'updateCardSelection']
  key_links:
    - from: 'src/main.ts'
      to: 'src/map.ts'
      via: 'Call linkMarkersToCards after initializeMap to link markers to StateManager'
      pattern: 'linkMarkersToCards|initializeMap'
    - from: 'src/main.ts'
      to: 'src/stateManager.ts'
      via: 'Import and create StateManager instance, pass to card and marker handlers'
      pattern: 'new StateManager|import.*StateManager'
    - from: 'src/map.ts'
      to: 'src/cards.ts'
      via: 'State changes trigger card DOM updates via updateCardSelection'
      pattern: 'updateCardSelection|aria-selected'
---

<objective>
Wire up click handlers for card-to-marker and marker-to-card highlighting with single-selection state using StateManager and L.Util.stamp() IDs.

**Purpose:** Users can click either cards or markers to highlight the corresponding item, with bi-directional synchronization and Escape key to clear.

**Output:** Working bi-directional sync between map markers and cards with visual highlighting and ARIA attribute updates.
</objective>

<execution_context>
@/home/erinmeaker/.claude/get-shit-done/workflows/execute-plan.md
@/home/erinmeaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-card-list-bi-directional-sync/02-RESEARCH.md
@.planning/phases/02-card-list-bi-directional-sync/02-01-PLAN.md
@.planning/phases/02-card-list-bi-directional-sync/02-02-PLAN.md
@src/map.ts
@src/cards.ts
@src/stateManager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export StateManager and add updateCardSelection to cards.ts</name>
  <files>src/stateManager.ts, src/cards.ts</files>
  <action>
    1. Update src/stateManager.ts:
       - Export StateManager class (add export keyword if not already present)

    2. Update src/cards.ts to add selection styling:

       Import SelectionState from stateManager.ts:
       ```typescript
       import type { SelectionState } from './stateManager.ts';
       ```

       Add updateCardSelection function:
       - Accepts parameters: selectedId: string | null
       - Gets card-list container
       - For each card element:
         * Get data-marker-id attribute
         * If markerId === selectedId: add 'selected' class (or set aria-selected="true")
         * Else: remove 'selected' class (or set aria-selected="false")
       - Use requestAnimationFrame for smooth visual updates

       Export updateCardSelection

    DO NOT:
    - Add click listeners directly in this function (handled in main.ts)
    - Create StateManager instance here (created in main.ts)

  </action>
  <verify>
    StateManager is exported. updateCardSelection function exists in cards.ts. TypeScript compiles: npm run build
  </verify>
  <done>
    src/stateManager.ts exports StateManager. src/cards.ts exports updateCardSelection function that updates aria-selected attributes based on selectedId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend map.ts with marker linking and highlight functions</name>
  <files>src/map.ts</files>
  <action>
    Update src/map.ts to add marker linking and highlight functions:

    1. Add imports at top:
       ```typescript
       import type { StateManager } from './stateManager.js';
       ```

    2. Create module-level variables for marker-card linking:
       - markerCardMap: Map<string, L.Marker> (maps marker ID to marker instance)

    3. Modify addMarkersFromCSV function:
       - After creating marker, get markerId using L.Util.stamp(marker)
       - Store in markerCardMap: markerCardMap.set(markerId.toString(), marker)
       - Return markerId (need to update function return type or pass callback)

       IMPORTANT: Since addMarkersFromCSV is currently void and exported, we need a way to return marker IDs. Options:
       a) Change return type to string[] and return array of marker IDs
       b) Add a callback parameter
       c) Create a parallel map that gets populated

       RECOMMENDED: Change return type to string[] and return array of marker IDs for all added markers.

    4. Add highlightMarker function:
       - Accepts: markerId: string | null, stateManager: StateManager
       - If markerId is null: clear all marker highlights (remove CSS class from all marker elements)
       - If markerId is not null:
         * Get marker from markerCardMap
         * Get marker element via marker.getElement()
         * Add CSS class 'selected' to element
         * Remove 'selected' class from all other marker elements

    5. Add setupMarkerClickHandlers function:
       - Accepts: stateManager: StateManager
       - Iterates markerCardMap entries
       - For each marker, adds 'click' event listener:
         * Gets markerId from L.Util.stamp(marker)
         * Calls stateManager.setSelected(markerId.toString())
       - Returns cleanup function that removes all click listeners

    6. Export: highlightMarker, setupMarkerClickHandlers, and the modified addMarkersFromCSV

    For marker CSS class:
    - Create 'marker-selected' class (not card-selected)
    - Use border-style or box-shadow to highlight marker icon element

    DO NOT:
    - Import StateManager in map.ts (use type import only)
    - Create StateManager instance here (created in main.ts)

  </action>
  <verify>
    map.ts exports highlightMarker and setupMarkerClickHandlers. addMarkersFromCSV returns string[]. TypeScript compiles: npm run build
  </verify>
  <done>
    src/map.ts has marker-card linking with L.Util.stamp() IDs. highlightMarker function updates marker CSS. setupMarkerClickHandlers adds click handlers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up StateManager, click handlers, and Escape key in main.ts</name>
  <files>src/main.ts</files>
  <action>
    Update src/main.ts to integrate StateManager, cards, and markers:

    1. Add imports:
       ```typescript
       import { StateManager } from './stateManager.ts';
       import { renderCards, updateCardSelection } from './cards.ts';
       import { addMarkersFromCSV, setupMarkerClickHandlers, highlightMarker } from './map.ts';
       import type { MarkerData } from './map.ts';
       ```

    2. Create StateManager instance at module level (before DOMContentLoaded):
       ```typescript
       const stateManager = new StateManager();
       ```

    3. Inside DOMContentLoaded, after initializeMap():
       - Load CSV data again (or cache from initializeMap - may need to refactor map.ts to return data)
       - Create LocationCard[] array with real marker IDs:
         * Need to get marker IDs from addMarkersFromCSV return value
         * This requires refactoring initializeMap or calling addMarkersFromCSV separately

       BETTER APPROACH: Refactor initializeMap to return marker data and layer groups, OR create a new function that handles the full pipeline.

       RECOMMENDED: Create initApp function that:
       - Creates StateManager
       - Calls initializeMap
       - Gets marker data (from addMarkersFromCSV return)
       - Links markers to cards
       - Sets up click handlers
       - Subscribes to state changes

    4. Subscribe to state changes:
       ```typescript
       stateManager.subscribe((state) => {
         updateCardSelection(state.selectedId);
         highlightMarker(state.selectedId, stateManager);
       });
       ```

    5. Add card click handlers:
       - After renderCards, get all card elements
       - Add click listener to each:
         * Get data-marker-id
         * Call stateManager.setSelected(markerId)
       - Return cleanup function

    6. Add Escape key listener on window:
       - Listen for 'keydown' event
       - If key === 'Escape', call stateManager.clearSelection()
       - Store listener reference for cleanup

    7. Setup marker click handlers:
       - Call setupMarkerClickHandlers(stateManager)

    For the marker ID linking:
    - Need to ensure marker IDs from addMarkersFromCSV match card marker IDs
    - Use the same L.Util.stamp() ID for both

    IMPORTANT: Since initializeMap is async and we need the marker IDs, we may need to:
    - Modify initializeMap to return the marker IDs
    - OR call addMarkersFromCSV separately in main.ts

    CHOICE: Modify initializeMap to return { markerIds: string[], fridgeLayer, donationLayer }

    DO NOT:
    - Use setTimeout for DOM timing (use requestAnimationFrame from phase 1 patterns)

  </action>
  <verify>
    main.ts creates StateManager, subscribes to state changes, sets up click handlers. Escape key clears selection. Build succeeds: npm run build
  </verify>
  <done>
    StateManager is created and shared between cards and markers. Click handlers call stateManager.setSelected(). Escape key calls stateManager.clearSelection(). State updates trigger visual highlights.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add marker highlight CSS styles</name>
  <files>src/cards.css</files>
  <action>
    Update src/cards.css to add marker highlight styles:

    1. Add .leaflet-marker-icon.marker-selected styles:
       - filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.8))
       - transform: scale(1.1)
       - transition: all 0.2s ease
       - outline: 3px solid #3b82f6
       - outline-offset: 2px

    2. Add transition to .leaflet-marker-icon base:
       - transition: filter 0.2s ease, transform 0.2s ease

    These styles will be applied to marker elements when selected.

  </action>
  <verify>
    CSS compiles without errors. Marker highlight styles are defined.
  </verify>
  <done>
    src/cards.css has marker-selected class with drop-shadow, scale, and outline for visual highlight effect.
  </done>
</task>

</tasks>

<verification>
Overall verification that plan is complete:

1. Run npm run build - TypeScript compiles without errors
2. Run npm run dev - Page loads without errors
3. In browser: Click a card -> corresponding marker highlights with blue shadow/border
4. In browser: Click a marker -> corresponding card highlights with blue border
5. In browser: Click another card -> previous selection cleared, only new one highlighted
6. In browser: Press Escape -> all selections cleared
7. Inspect element: Selected card has aria-selected="true"
8. Inspect element: Selected marker has marker-selected CSS class
9. Console: No errors related to state management or click handlers
   </verification>

<success_criteria>
Plan is complete when:

1. StateManager is imported and instantiated in main.ts
2. Card clicks trigger stateManager.setSelected(markerId)
3. Marker clicks trigger stateManager.setSelected(markerId)
4. State changes update both card aria-selected and marker CSS classes
5. Only one item (card or marker) is selected at a time
6. Escape key clears all selections via stateManager.clearSelection()
7. Visual feedback is clear (blue border on card, shadow on marker)
8. No race conditions or timing issues (use requestAnimationFrame)
9. L.Util.stamp() IDs correctly link markers to cards
   </success_criteria>

<output>
After completion, create `.planning/phases/02-card-list-bi-directional-sync/02-03-SUMMARY.md`
</output>
