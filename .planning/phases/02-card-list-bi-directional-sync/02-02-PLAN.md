---
phase: 02-card-list-bi-directional-sync
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/stateManager.ts
  - src/test/stateManager.test.ts
autonomous: true

must_haves:
  truths:
    - 'StateManager tracks selected item with single-selection state'
    - 'Selecting an item deselects the previous item'
    - 'Multiple listeners can subscribe to state changes'
    - 'Listeners are notified when state changes'
    - 'Subscribers can unsubscribe from notifications'
    - 'clearSelection() deselects all items'
  artifacts:
    - path: 'src/stateManager.ts'
      provides: 'Observer pattern state management for selection'
      exports: ['StateManager']
      contains: ['class StateManager', 'subscribe', 'setSelected', 'clearSelection']
    - path: 'src/test/stateManager.test.ts'
      provides: 'Unit tests for StateManager'
      contains: ["describe('StateManager')", "it('should notify listeners'"]
      min_lines: 80
  key_links:
    - from: 'src/stateManager.ts'
      to: '(future plan 02-03)'
      via: 'Will be imported by click handlers'
      pattern: 'StateManager class will be used in plan 02-03'
---

<objective>
Implement StateManager class using TDD with Observer pattern for bi-directional marker-card synchronization.

**Purpose:** Single source of truth for selection state between map markers and DOM cards. Decouples marker and card logic.

**Output:** Fully tested StateManager class with subscribe/notify pattern for selection state changes.
</objective>

<execution_context>
@/home/erinmeaker/.claude/get-shit-done/workflows/execute-tdd-plan.md
@/home/erinmeaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-card-list-bi-directional-sync/02-RESEARCH.md
@.planning/phases/01-type-safety-test-infrastructure/01-03-SUMMARY.md
</context>

<feature>
  <name>StateManager for single-selection state</name>
  <files>src/stateManager.ts, src/test/stateManager.test.ts</files>
  <behavior>
    Manages single-selection state with Observer pattern:

    1. State shape: { selectedId: string | null }
    2. setSelected(id: string) sets selectedId, deselects previous, notifies listeners
    3. clearSelection() sets selectedId to null, notifies listeners
    4. subscribe(listener) registers callback, returns unsubscribe function
    5. getState() returns readonly state snapshot
    6. Listeners receive { selectedId: string | null } on any state change

    Test cases:
    - Initial state has selectedId = null
    - setSelected('marker-123') updates state and notifies listeners
    - setSelected again deselects previous and notifies with new ID
    - clearSelection() sets selectedId to null and notifies listeners
    - subscribe() returns unsubscribe function that removes listener
    - Multiple listeners all receive state updates
    - getState() returns immutable state snapshot
    - setSelected same ID twice does not trigger notification (no-op)

  </behavior>
  <implementation>
    Create src/stateManager.ts:

    1. Define SelectionState interface:
       ```typescript
       interface SelectionState {
         selectedId: string | null;
       }
       ```

    2. Define StateListener type:
       ```typescript
       type StateListener = (state: SelectionState) => void;
       ```

    3. Create StateManager class with:
       - private state: SelectionState = { selectedId: null }
       - private listeners: StateListener[] = []
       - getState(): SelectionState (returns { ...this.state })
       - setSelected(id: string): void
       - clearSelection(): void
       - subscribe(listener: StateListener): () => void
       - private notify(): void

    4. setSelected logic:
       - If this.state.selectedId !== id: update state, call notify()
       - If same ID: return early (no notification)

    5. clearSelection logic:
       - If this.state.selectedId !== null: set to null, call notify()
       - If already null: return early (no notification)

    6. subscribe logic:
       - Push listener to array
       - Return function that filters listener out of array

  </implementation>
</feature>

<success_criteria>
Plan is complete when:

1. src/stateManager.ts exports StateManager class
2. src/test/stateManager.test.ts has all tests passing
3. All test cases from behavior section are covered
4. npm test shows 100% pass rate for stateManager tests
5. getState() returns immutable state (spread operator)
6. subscribe() returns unsubscribe function
7. setSelected same ID twice is a no-op (no notification)
8. clearSelection() when already null is a no-op
   </success_criteria>

<output>
After completion, create `.planning/phases/02-card-list-bi-directional-sync/02-02-SUMMARY.md`
</output>
