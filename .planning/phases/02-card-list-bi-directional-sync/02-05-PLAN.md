---
phase: 02-card-list-bi-directional-sync
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/map.ts
  - src/main.ts
  - src/test/map.test.ts
  - e2e/map.spec.ts
autonomous: true
gap_closure: true
user_setup: []

must_haves:
  truths:
    - "Clicking a marker highlights the corresponding card but does NOT open a popup"
    - "Pressing Enter/Space on a focused marker highlights the card but does NOT open a popup"
    - "The Escape key clears selections without needing to close popups"
    - "All popup-related code has been removed from the codebase"
    - "Unit tests no longer verify popup behavior"
    - "E2E tests no longer verify popup behavior"
  artifacts:
    - path: "src/map.ts"
      provides: "Map markers without popup binding"
      contains:
        - "No popupAnchor in icon definitions"
        - "No bindPopup() calls"
        - "No openPopup() calls"
        - "No popupopen event handlers"
        - "No closePopup() function or export"
        - "No mapInstance variable"
    - path: "src/main.ts"
      provides: "Main entry without popup imports or calls"
      contains:
        - "No closePopup import"
        - "No closePopup() calls in Escape handler"
    - path: "src/test/map.test.ts"
      provides: "Unit tests without popup assertions"
      contains:
        - "No popup content verification tests"
        - "No popupopen event listener tests"
    - path: "e2e/map.spec.ts"
      provides: "E2E tests without popup verification"
      contains:
        - "No popup opening test"
  key_links:
    - from: "src/map.ts"
      to: "src/main.ts"
      via: "Marker click handlers use StateManager only, no popup calls"
      pattern: "stateManager.setSelected"
    - from: "src/map.ts"
      to: "Leaflet markers"
      via: "Marker keyboard handlers call StateManager, not openPopup()"
      pattern: "stateManager.setSelected"
---

<objective>
Remove all Leaflet popup logic since cards contain all relevant information. The popup functionality is redundant and adds unnecessary complexity.

Purpose: Simplify the application by removing duplicate information display. Cards show all location details (name, description, address), making popups redundant. This also fixes the UAT issue where popups remained open when clicking different cards.

Output: Clean codebase without any popup-related code - markers only highlight corresponding cards via StateManager.
</objective>

<execution_context>
@/home/erinmeaker/.claude/get-shit-done/workflows/execute-plan.md
@/home/erinmeaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-card-list-bi-directional-sync/02-UAT.md
@.planning/phases/02-card-list-bi-directional-sync/02-01-SUMMARY.md
@.planning/phases/02-card-list-bi-directional-sync/02-03-SUMMARY.md
@.planning/phases/02-card-list-bi-directional-sync/02-04-SUMMARY.md

# Key context from prior plans:
- Plan 02-01: Created card list UI with all location information (name, description, address)
- Plan 02-03: Bi-directional sync using StateManager - clicking markers updates card selection
- Plan 02-04: Added closePopup() function for Escape key (now being removed entirely)

# Gap being closed:
UAT Test 6 failed - clicking marker opens popup, then clicking different card leaves popup open.
User requested removal of ALL popup logic as cards already display all information.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove popup binding and keyboard handlers from map.ts</name>
  <files>src/map.ts</files>
  <action>
    From src/map.ts, remove ALL popup-related code:

    1. Lines 28, 35: Remove popupAnchor property from fridgeIcon and donationIcon definitions
    2. Lines 89-95: Remove popup content creation and bindPopup() call inside addMarkersFromCSV
    3. Lines 104-109: Remove keyboard event listener that opens popup on Enter/Space
    4. Lines 112-114: Remove popupopen event handler and ARIA announcement
    5. Lines 21-22, 163-167: Remove mapInstance variable and closePopup() function entirely
    6. Line 253: Remove mapInstance = map assignment

    IMPORTANT: Keep the existing marker click handler setup via setupMarkerClickHandlers() - this uses StateManager for bi-directional sync, which is the desired behavior.

    For the keyboard handler (lines 104-109), DO NOT just remove it - REPLACE the openPopup() call with stateManager.setSelected(markerId) call. This maintains keyboard accessibility while removing popups. You'll need to pass StateManager as a parameter to addMarkersFromCSV.

    Reference existing patterns from 02-03-SUMMARY.md for StateManager usage.
  </action>
  <verify>
    Run npm run build - should succeed without errors
    Run npm test - all tests should pass (after Task 2 updates tests)
    grep -r "bindPopup\|openPopup\|closePopup\|popupAnchor\|popupopen" src/map.ts -- should return nothing
  </verify>
  <done>
    - No popupAnchor in icon definitions
    - No bindPopup() or openPopup() calls
    - No popupopen event handlers
    - No closePopup() function
    - No mapInstance variable
    - Keyboard Enter/Space triggers StateManager selection instead of popup
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove closePopup import and call from main.ts</name>
  <files>src/main.ts</files>
  <action>
    From src/main.ts, remove popup-related code:

    1. Line 8: Remove closePopup from the import statement
    2. Line 89: Remove closePopup() call from the escapeHandler function

    The Escape key should still call stateManager.clearSelection() - keep that. Just remove the popup closing since popups no longer exist.
  </action>
  <verify>
    Run npm run build - should succeed without errors
    grep "closePopup" src/main.ts -- should return nothing
  </verify>
  <done>
    - No closePopup import from map.ts
    - No closePopup() call in Escape key handler
    - Escape key still clears selections via stateManager.clearSelection()
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove and update popup-related unit tests in map.test.ts</name>
  <files>src/test/map.test.ts</files>
  <action>
    From src/test/map.test.ts:

    1. Line 154: Remove popupAnchor from icon definition in beforeEach
    2. Lines 179-200: DELETE the entire test "should create markers with popup content" - this test is no longer relevant
    3. Lines 290, 314-315: In test "should handle markers with missing optional description", remove the popup assertion (expect(marker.getPopup()).toBeTruthy())
    4. Lines 314-315: In test "should add ARIA attributes to marker elements", remove the popupopen event listener assertion (expect(marker.listens('popupopen')).toBe(true))

    Keep all other tests - they verify marker creation, coordinate validation, ARIA attributes, etc.
  </action>
  <verify>
    Run npm test -- --run src/test/map.test.ts - all tests should pass
  </verify>
  <done>
    - No popupAnchor in test icon definitions
    - No popup content tests
    - No popupopen event listener tests
    - All other marker tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 4: Remove popup E2E test from map.spec.ts</name>
  <files>e2e/map.spec.ts</files>
  <action>
    From e2e/map.spec.ts:

    Lines 91-100: DELETE the entire test "should open popup when marker is clicked" including the test.skip() directive for Firefox

    Keep all other E2E tests - they verify map loading, layer controls, accessibility, etc.
  </action>
  <verify>
    Run npm run test:e2e (if available) or note that E2E tests will be skipped
    grep -n "popup" e2e/map.spec.ts -- should return nothing
  </verify>
  <done>
    - No popup opening E2E test
    - All other E2E tests still exist
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. Build succeeds: npm run build
2. Unit tests pass: npm test
3. No popup references remain in source code:
   grep -r "bindPopup\|openPopup\|closePopup\|popupAnchor\|popupopen" src/ -- should return nothing
4. No popup tests remain:
   grep -r "popup" src/test/ e2e/ -- should return nothing
5. Manual verification (optional):
   - Start dev server
   - Click a marker - card highlights, no popup appears
   - Click a different card - marker highlight moves, no popup involved
   - Press Escape - selections clear
</verification>

<success_criteria>
1. All popup-related code removed from src/map.ts (5 code blocks removed)
2. All popup-related code removed from src/main.ts (import and call removed)
3. Popup unit test deleted, other tests updated to remove popup assertions
4. Popup E2E test deleted
5. Build passes without errors
6. All unit tests pass
7. Markers still highlight cards via StateManager (bi-directional sync preserved)
8. Keyboard accessibility preserved (Enter/Space still works, just triggers selection instead of popup)
</success_criteria>

<output>
After completion, create `.planning/phases/02-card-list-bi-directional-sync/02-05-SUMMARY.md`
</output>
