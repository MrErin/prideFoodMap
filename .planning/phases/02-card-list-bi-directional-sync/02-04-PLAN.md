---
phase: 02-card-list-bi-directional-sync
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [src/map.ts, src/main.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Pressing Escape key always closes any open Leaflet popup"
    - "Pressing Escape key removes marker highlight CSS class"
    - "Pressing Escape key removes card selection blue border"
    - "Visual state is fully cleared (popup, marker, and card) after Escape"
  artifacts:
    - path: "src/map.ts"
      provides: "closePopup() function to close all open popups"
      exports: ["closePopup"]
    - path: "src/main.ts"
      provides: "Escape handler that closes popups when selection cleared"
      contains: "closePopup() call in escapeHandler or state subscription"
  key_links:
    - from: "src/main.ts escapeHandler"
      to: "src/map.ts closePopup()"
      via: "import and function call"
      pattern: "closePopup\\(\\)"
---

<objective>
Fix Escape key popup closing behavior so that pressing Escape when a popup is open closes the popup, removes marker highlight, and clears card selection.

Purpose: UAT Test 6 failed - when a marker popup is open and Escape is pressed, the popup stays open and marker highlight remains visible. Only the card selection blue border is removed. This is a gap closure from diagnosed issue in 02-UAT.md.

Output: Working Escape key behavior that fully clears all visual state (popup, marker highlight, card selection)
</objective>

<execution_context>
@/home/erinmeaker/.claude/get-shit-done/workflows/execute-plan.md
@/home/erinmeaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-card-list-bi-directional-sync/02-UAT.md
@.planning/debug/escape-key-popup-issue.md

# Gap details from UAT:
- truth: "Pressing Escape key always clears all selections - blue border disappears from cards and marker highlight is removed, popup closes if open"
- status: failed
- root_cause: "The Escape key handler calls stateManager.clearSelection() which updates state and removes marker-selected CSS class, but does NOT close the Leaflet popup. highlightMarker() function only manipulates CSS classes, never calls map.closePopup() or marker.closePopup()."

# Existing code context:
From 02-01-SUMMARY.md: Cards system with LocationCard interface and markerId linking
From 02-02-SUMMARY.md: StateManager with Observer pattern for selection state
From 02-03-SUMMARY.md: Bi-directional sync with highlightMarker() and click handlers
</context>

<tasks>

<task type="auto">
  <name>Export map instance and create closePopup function in map.ts</name>
  <files>src/map.ts</files>
  <action>
Add a module-level variable to store the map instance and a closePopup() function to close all open popups:

1. Add module-level variable at top of file after markerCardMap:
   ```typescript
   let mapInstance: L.Map | null = null;
   ```

2. In initializeMap(), store the map instance after creating it:
   ```typescript
   export const initializeMap = async (): Promise<InitializeMapResult> => {
     const map: L.Map = L.map('map').setView([37.8, -96], 4);
     mapInstance = map; // Store for later access
     // ... rest of function
   ```

3. Add closePopup() function after highlightMarker():
   ```typescript
   /**
    * Closes all open popups on the map.
    * Used by Escape key handler to clear popup state when selection is cleared.
    */
   export function closePopup(): void {
     if (mapInstance) {
       mapInstance.closePopup();
     }
   }
   ```

DO NOT modify highlightMarker() - it only handles CSS class manipulation and should remain focused on that single responsibility.
  </action>
  <verify>
Build succeeds: npm run build
</verify>
  <done>map.ts exports closePopup() function that calls mapInstance.closePopup()</done>
</task>

<task type="auto">
  <name>Call closePopup() in Escape key handler</name>
  <files>src/main.ts</files>
  <action>
Import closePopup from map.ts and call it in the escapeHandler:

1. Add closePopup to the import statement from './map.ts':
   ```typescript
   import {
     initializeMap,
     setupMarkerClickHandlers,
     highlightMarker,
     setupLayerEventListeners,
     announce,
     closePopup,  // Add this
   } from './map.ts';
   ```

2. In the escapeHandler (around line 85-89), add closePopup() call:
   ```typescript
   const escapeHandler = (e: KeyboardEvent) => {
     if (e.key === 'Escape') {
       stateManager.clearSelection();
       closePopup();  // Add this line
     }
   };
   ```

This ensures that when Escape is pressed, both the selection state is cleared AND any open popup is closed.
  </action>
  <verify>
Build succeeds: npm run build
</verify>
  <done>Escape key handler calls closePopup() to close any open Leaflet popup</done>
</task>

</tasks>

<verification>
Manual test:
1. Click on a map marker to open its popup
2. Press the Escape key
3. Verify: Popup closes, marker highlight is removed, card selection is cleared

Expected behavior: All visual state (popup, marker drop-shadow, card blue border) is cleared when Escape is pressed.
</verification>

<success_criteria>
- Escape key closes open Leaflet popup
- Escape key removes marker highlight CSS class
- Escape key removes card selection blue border
- All visual state is fully cleared after Escape
- No console errors during Escape key handling
</success_criteria>

<output>
After completion, create `.planning/phases/02-card-list-bi-directional-sync/02-04-SUMMARY.md`
</output>
