---
phase: 01-type-safety-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/map.test.ts
autonomous: true

must_haves:
  truths:
    - "All test mocks use vi.spyOn() with proper TypeScript types (no 'as any')"
    - 'TypeScript compilation completes without type errors in test files'
    - 'All existing tests still pass after refactoring'
  artifacts:
    - path: 'src/test/map.test.ts'
      provides: 'Type-safe test mocks for fetch API'
      contains: "vi.spyOn(global, 'fetch')"
      excludes: '(global.fetch as any)'
  key_links:
    - from: 'src/test/map.test.ts'
      to: 'global.fetch'
      via: 'vi.spyOn() with proper Response typing'
      pattern: "vi\\.spyOn\\(global,\\s*'fetch'\\)"
---

<objective>
Replace type-unsafe `(global.fetch as any)` assertions with properly typed `vi.spyOn()` mocks in test files.

Purpose: Eliminate TypeScript `any` type usage that bypasses type checking, ensuring tests benefit from compile-time type safety and catch API contract mismatches early.

Output: Type-safe test mocks using `vi.spyOn()` with proper Response typing.
</objective>

<execution_context>
@/home/erinmeaker/.claude/get-shit-done/workflows/execute-plan.md
@/home/erinmeaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-type-safety-test-infrastructure/01-RESEARCH.md
@.planning/codebase/TESTING.md
@src/test/map.test.ts
@src/map.ts
</context>

<tasks>

<task type="auto">
  <name>Replace fetch mocks with type-safe vi.spyOn() calls</name>
  <files>src/test/map.test.ts</files>
  <action>
    Refactor all fetch mocks in src/test/map.test.ts:

    1. Remove `global.fetch = vi.fn()` from beforeEach (line 6)
    2. Replace each `(global.fetch as any)` with properly typed `vi.spyOn(global, 'fetch')`
    3. Use mockImplementation() to provide type-safe Response mock objects

    Follow this pattern for each mock call:
    ```typescript
    // Create a helper function at the top of the file for type-safe Response creation
    const createMockResponse = (text: string, ok = true): Partial<Response> => ({
      ok,
      status: ok ? 200 : 404,
      statusText: ok ? 'OK' : 'Not Found',
      text: () => Promise.resolve(text),
      headers: new Headers(),
      redirected: false,
      url: '',
      clone: () => ({} as Response),
      json: () => Promise.resolve({}),
      blob: () => Promise.resolve(new Blob()),
      formData: () => Promise.resolve(new FormData()),
      arrayBuffer: () => Promise.resolve(new ArrayBuffer(0)),
      body: null,
      bodyUsed: false,
    });

    // In beforeEach:
    let fetchSpy: ReturnType<typeof vi.spyOn>;
    beforeEach(() => {
      fetchSpy = vi.spyOn(global, 'fetch').mockImplementation(
        async (input: RequestInfo | URL, init?: RequestInit): Promise<Response> => {
          return createMockResponse(mockCSV, true) as Response;
        }
      );
    });

    // In afterEach:
    afterEach(() => {
      fetchSpy.mockRestore();
      vi.restoreAllMocks();
    });
    ```

    Locations to update:
    - Line 17: loadCSV test - first fetch mock
    - Line 31: loadCSV test - error response mock
    - Line 39: loadCSV test - network error mock
    - Line 50: loadCSV test - multiple rows mock
    - Line 62: loadCSV test - empty CSV mock

    Do NOT modify the announce() tests - they don't use fetch mocks.

    Reference: .planning/phases/01-type-safety-test-infrastructure/01-RESEARCH.md lines 65-104

  </action>
  <verify>
    1. Run `npm test` - all tests should pass
    2. Run `npx tsc --noEmit` - no TypeScript errors
    3. Run `grep -n "as any" src/test/map.test.ts` - should return empty
  </verify>
  <done>
    - All `(global.fetch as any)` replaced with `vi.spyOn(global, 'fetch')`
    - createMockResponse helper function defined with proper Response typing
    - beforeEach/afterEach properly set up spy restoration
    - All tests pass (npm test)
    - No TypeScript type errors (npx tsc --noEmit)
  </done>
</task>

</tasks>

<verification>
After completing the tasks, verify:

1. Type safety: `grep -r "as any" src/test/` returns no results
2. Tests pass: `npm test` executes successfully
3. TypeScript compilation: `npx tsc --noEmit` completes without errors
4. Code review: All fetch mocks use vi.spyOn() pattern with explicit spy restoration
   </verification>

<success_criteria>

1. Zero `as any` type assertions in src/test/map.test.ts
2. All existing tests pass after refactoring
3. TypeScript compilation completes without type errors
4. Test mocks are properly restored in afterEach hooks
   </success_criteria>

<output>
After completion, create `.planning/phases/01-type-safety-test-infrastructure/01-01-SUMMARY.md`
</output>
